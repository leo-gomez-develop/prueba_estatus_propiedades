<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Proceso de Viviendas (Google Sheets)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Estilos para el checkbox de Tailwind por defecto */
        .form-checkbox {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            display: inline-block;
            vertical-align: middle;
            height: 1.25rem; /* h-5 */
            width: 1.25rem;  /* w-5 */
            border-width: 1px;
            border-radius: 0.375rem; /* rounded-md */
            border-color: #D1D5DB; /* gray-300 */
            background-color: #FFFFFF; /* white */
            cursor: pointer;
        }
        .form-checkbox:checked {
            background-color: #2563EB; /* blue-600 */
            border-color: #2563EB; /* blue-600 */
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 00-1.414 0L7 8.586 4.207 5.793a1 1 0 00-1.414 1.414l3.5 3.5a1 1 0 001.414 0l5-5a1 1 0 000-1.414z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* ring-blue-500 */
        }
        /* Estilos para el mensaje flotante */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-box.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        /* Estilos para el campo de contraseña con icono */
        .password-input-container {
            position: relative;
            width: 100%;
        }
        .password-toggle-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6B7280; /* gray-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 flex flex-col items-center justify-center p-4">
    <div id="app-container" class="w-full max-w-4xl">
        <!-- El contenido de la aplicación se renderizará aquí -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-xl font-semibold text-gray-700">Cargando aplicación...</div>
        </div>
    </div>

    <!-- Contenedor para mensajes flotantes -->
    <div id="messageBox" class="message-box"></div>

    <script type="module">
        // =====================================================================================================
        // ¡IMPORTANTE! URL de tu Google Apps Script desplegado.
        // Reemplaza 'TU_URL_DE_APPS_SCRIPT_AQUI' con la URL real que obtuviste al desplegar tu script.
        // Esta URL es para tu proyecto 'estatus-propiedades'.
        // =====================================================================================================
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx3VfeNpv67awOvghe6qZj8z08499CTerwWG4hPN-picWIPGWJ5cZSk2sOvhSpxM7rc/exec';

        // Variables globales para el estado de la aplicación
        let currentView = 'login'; // 'login', 'admin', 'client'
        let selectedClientForUpdate = null; // Cliente seleccionado para actualizar estatus
        let selectedClientForEdit = null; // Cliente seleccionado para editar datos

        // Configuración de los pasos predeterminados del proceso de compra
        const defaultProcessSteps = [
            { stepName: "Documentación Inicial", completed: false },
            { stepName: "Revisión Legal", completed: false },
            { stepName: "Avalúo de la Propiedad", completed: false },
            { stepName: "Firma de Contrato de Compra-Venta", completed: false },
        ];

        // Referencia al contenedor principal de la aplicación
        const appContainer = document.getElementById('app-container');
        const messageBox = document.getElementById('messageBox');

        /**
         * Muestra un mensaje flotante al usuario.
         * @param {string} message - El texto del mensaje.
         * @param {string} type - El tipo de mensaje ('success', 'error', 'info').
         */
        const showMessage = (message, type = 'info') => {
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`;
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // El mensaje desaparece después de 3 segundos
        };

        /**
         * Función para hacer llamadas al Google Apps Script.
         * @param {string} action - La acción que el Apps Script debe realizar (ej. 'getClients', 'addClient', 'updateClient').
         * @param {Object} data - Los datos a enviar al Apps Script.
         * @returns {Promise<Object>} - Una promesa que resuelve con la respuesta del Apps Script.
         */
        const callAppsScript = async (action, data = {}) => {
            if (GOOGLE_APPS_SCRIPT_URL === 'TU_URL_DE_APPS_SCRIPT_AQUI') {
                showMessage('Error: La URL de Google Apps Script no ha sido configurada.', 'error');
                console.error('GOOGLE_APPS_SCRIPT_URL no configurada.');
                return null;
            }

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // Necesario para llamadas entre dominios
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded', // Formato para Apps Script POST
                    },
                    body: new URLSearchParams({
                        action: action,
                        data: JSON.stringify(data)
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.message || 'Error desconocido del Apps Script.');
                }
                return result.data;
            } catch (error) {
                console.error(`Error al llamar a Apps Script para la acción "${action}":`, error);
                showMessage(`Error de comunicación: ${error.message}`, 'error');
                return null;
            }
        };

        /**
         * Cambia la vista de la aplicación y renderiza el componente correspondiente.
         * @param {string} viewName - El nombre de la vista a la que navegar ('login', 'admin', 'client').
         */
        const navigateTo = (viewName) => {
            console.log("Navegando a la vista:", viewName);
            currentView = viewName;
            switch (currentView) {
                case 'login':
                    renderLoginScreen();
                    break;
                case 'admin':
                    renderAdminDashboard();
                    break;
                case 'client':
                    renderClientDashboard();
                    break;
                default:
                    renderLoginScreen();
            }
        };

        /**
         * Renderiza la pantalla de inicio de sesión.
         */
        const renderLoginScreen = () => {
            let isClientLogin = true; // Estado para alternar entre login de cliente y admin
            let loginMessage = ''; // Mensaje específico para el formulario de login
            console.log("Renderizando pantalla de login.");

            const updateLoginScreen = () => {
                appContainer.innerHTML = `
                    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-6">
                            ${isClientLogin ? 'Acceso Clientes' : 'Acceso Administrador'}
                        </h2>

                        <div class="flex justify-center mb-6">
                            <button id="clientLoginBtn"
                                class="px-6 py-2 rounded-l-full font-semibold transition-all duration-300 ${
                                    isClientLogin ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }">
                                Cliente
                            </button>
                            <button id="adminLoginBtn"
                                class="px-6 py-2 rounded-r-full font-semibold transition-all duration-300 ${
                                    !isClientLogin ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }">
                                Administrador
                            </button>
                        </div>

                        <input type="text" id="identifierInput" placeholder="${isClientLogin ? 'Usuario' : 'Usuario (admin)'}"
                            class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" />
                        
                        <div class="password-input-container mb-6">
                            <input type="password" id="passwordInput" placeholder="${isClientLogin ? 'Contraseña' : 'Contraseña (admin)'}"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" />
                            <span class="password-toggle-icon" id="togglePassword">
                                <!-- Icono de ojo SVG -->
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </span>
                        </div>

                        <button id="loginButton"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-all duration-300 shadow-md">
                            Ingresar
                        </button>
                        ${loginMessage ? `<p class="mt-4 text-red-600 text-sm">${loginMessage}</p>` : ''}
                    </div>
                `;

                // Adjuntar listeners de eventos
                document.getElementById('clientLoginBtn').onclick = () => {
                    isClientLogin = true;
                    loginMessage = ''; // Limpiar mensaje al cambiar de tipo de login
                    updateLoginScreen();
                };
                document.getElementById('adminLoginBtn').onclick = () => {
                    isClientLogin = false;
                    loginMessage = ''; // Limpiar mensaje al cambiar de tipo de login
                    updateLoginScreen();
                };
                document.getElementById('loginButton').onclick = handleLogin;

                // Toggle password visibility
                const togglePassword = document.getElementById('togglePassword');
                const passwordInput = document.getElementById('passwordInput');
                togglePassword.addEventListener('click', function () {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    // Cambiar el icono si es necesario (opcional, el SVG ya funciona bien)
                });
            };

            const handleLogin = async () => {
                loginMessage = '';
                const identifier = document.getElementById('identifierInput').value;
                const password = document.getElementById('passwordInput').value;

                if (!identifier || !password) {
                    loginMessage = 'Por favor, ingresa tus credenciales.';
                    showMessage('Por favor, ingresa tus credenciales.', 'error');
                    updateLoginScreen();
                    return;
                }

                if (isClientLogin) {
                    console.log("Intentando login de cliente...");
                    const clients = await callAppsScript('getClients');
                    if (!clients) {
                        loginMessage = 'Error al cargar datos de clientes. Inténtalo de nuevo.';
                        updateLoginScreen();
                        return;
                    }

                    const client = clients.find(c => c.Usuario === identifier); // Buscar por usuario primero

                    if (client) {
                        // --- Logs de depuración para la contraseña ---
                        console.log(`Contraseña ingresada (tipo: ${typeof password}, valor: '${password}')`);
                        console.log(`Contraseña de la hoja (tipo: ${typeof client.Contrasena}, valor: '${client.Contrasena}')`);
                        // --- Fin de logs de depuración ---

                        // Asegurarse de comparar como strings
                        if (String(client.Contrasena) === String(password)) {
                            localStorage.setItem('loggedInClientUid', client.ID); // Usamos el ID de la fila como UID
                            navigateTo('client');
                            showMessage('¡Bienvenido!', 'success');
                        } else {
                            loginMessage = 'Usuario o contraseña incorrectos.';
                            showMessage('Usuario o contraseña incorrectos.', 'error');
                            updateLoginScreen();
                        }
                    } else {
                        loginMessage = 'Usuario o contraseña incorrectos.';
                        showMessage('Usuario o contraseña incorrectos.', 'error');
                        updateLoginScreen();
                    }
                } else { // Admin Login (¡ADVERTENCIA DE SEGURIDAD!)
                    console.log("Intentando login de administrador...");
                    // ESTE ES UN LOGIN DE ADMINISTRADOR MUY BÁSICO Y NO SEGURO PARA PRODUCCIÓN.
                    // Las credenciales están codificadas en el cliente.
                    // Para producción, se DEBE implementar una autenticación segura (ej. Google Identity Platform).
                    const ADMIN_USERNAME = 'admin';
                    const ADMIN_PASSWORD = 'admin'; 

                    if (identifier === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                        localStorage.setItem('isAdminLoggedIn', 'true');
                        navigateTo('admin');
                        showMessage('¡Bienvenido Administrador!', 'success');
                    } else {
                        loginMessage = 'Credenciales de administrador incorrectas.';
                        showMessage('Credenciales de administrador incorrectas.', 'error');
                        updateLoginScreen();
                    }
                }
            };

            updateLoginScreen(); // Renderizar la pantalla inicial
        };

        /**
         * Función para poblar los selectores de fecha (Año, Mes, Día).
         * @param {string} daySelectId - ID del selector de día.
         * @param {string} monthSelectId - ID del selector de mes.
         * @param {string} yearSelectId - ID del selector de año.
         * @param {string} initialDay - Día inicial seleccionado (ej. '01').
         * @param {string} initialMonth - Mes inicial seleccionado (ej. '01').
         * @param {string} initialYear - Año inicial seleccionado (ej. '2000').
         */
        const populateDateDropdowns = (daySelectId, monthSelectId, yearSelectId, initialDay = '', initialMonth = '', initialYear = '') => {
            const daySelect = document.getElementById(daySelectId);
            const monthSelect = document.getElementById(monthSelectId);
            const yearSelect = document.getElementById(yearSelectId);

            // Limpiar opciones previas
            daySelect.innerHTML = '<option value="">Día</option>';
            monthSelect.innerHTML = '<option value="">Mes</option>';
            yearSelect.innerHTML = '<option value="">Año</option>';

            // Poblar años (ej. desde 1900 hasta el año actual)
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= 1900; i--) {
                const option = document.createElement('option');
                option.value = String(i);
                option.textContent = String(i);
                if (option.value === initialYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }

            // Poblar meses
            const months = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];
            for (let i = 0; i < months.length; i++) {
                const option = document.createElement('option');
                option.value = String(i + 1).padStart(2, '0');
                option.textContent = months[i];
                if (option.value === initialMonth) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            }

            // Añadir listeners para actualizar días cuando mes/año cambian
            const updateDaysInMonth = () => {
                const year = parseInt(yearSelect.value);
                const month = parseInt(monthSelect.value);
                const currentDay = daySelect.value; // Guardar el día actual seleccionado

                // Limpiar y repoblar días
                daySelect.innerHTML = '<option value="">Día</option>';
                if (year && month) {
                    const daysInMonth = new Date(year, month, 0).getDate(); // Día 0 del siguiente mes da el último día del mes actual
                    for (let i = 1; i <= daysInMonth; i++) {
                        const option = document.createElement('option');
                        option.value = String(i).padStart(2, '0');
                        option.textContent = String(i).padStart(2, '0');
                        if (parseInt(currentDay) === i) { // Intentar mantener el día seleccionado si es válido
                            option.selected = true;
                        }
                        daySelect.appendChild(option);
                    }
                }
            };

            monthSelect.onchange = updateDaysInMonth;
            yearSelect.onchange = updateDaysInMonth;
            // Llamada inicial para poblar los días correctamente
            updateDaysInMonth();
        };

        /**
         * Función para poblar el selector de la lada internacional.
         * @param {string} selectElementId - ID del selector de lada.
         * @param {string} defaultCode - Código de país por defecto (ej. '+52').
         */
        const populateDialCodeDropdown = (selectElementId, defaultCode = '+52') => {
            const select = document.getElementById(selectElementId);
            if (!select) return;

            select.innerHTML = ''; // Limpiar opciones existentes

            const dialCodes = [
                { code: '+1', name: 'USA/Canadá (+1)' },
                { code: '+52', name: 'México (+52)' },
                { code: '+54', name: 'Argentina (+54)' },
                { code: '+56', name: 'Chile (+56)' },
                { code: '+57', name: 'Colombia (+57)' },
                { code: '+34', name: 'España (+34)' },
                { code: '+51', name: 'Perú (+51)' },
                { code: '+55', name: 'Brasil (+55)' },
                { code: '+502', name: 'Guatemala (+502)' },
                { code: '+503', name: 'El Salvador (+503)' },
                { code: '+504', name: 'Honduras (+504)' },
                { code: '+505', name: 'Nicaragua (+505)' },
                { code: '+506', name: 'Costa Rica (+506)' },
                { code: '+507', name: 'Panamá (+507)' },
                { code: '+508', name: 'Saint-Pierre y Miquelon (+508)' },
                { code: '+509', name: 'Haití (+509)' },
                { code: '+591', name: 'Bolivia (+591)' },
                { code: '+593', name: 'Ecuador (+593)' },
                { code: '+595', name: 'Paraguay (+595)' },
                { code: '+598', name: 'Uruguay (+598)' },
                { code: '+599', name: 'Curazao (+599)' },
                // Agrega más según sea necesario
            ];

            dialCodes.forEach(item => {
                const option = document.createElement('option');
                option.value = item.code;
                option.textContent = item.name;
                if (item.code === defaultCode) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        };


        /**
         * Renderiza el panel de administrador.
         */
        const renderAdminDashboard = async () => {
            let clients = [];
            let showRegisterForm = false;
            let adminMessage = '';
            
            const fetchClients = async () => {
                console.log("Obteniendo clientes de Google Sheets...");
                const fetchedClients = await callAppsScript('getClients');
                if (fetchedClients) {
                    clients = fetchedClients;
                    console.log("Clientes cargados:", clients.length);
                } else {
                    showMessage('Error al cargar clientes desde Google Sheets.', 'error');
                    console.error('No se pudieron cargar clientes.');
                }
                updateAdminDashboard();
            };

            const updateAdminDashboard = () => {
                appContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-xl max-w-4xl w-full mx-auto my-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-extrabold text-gray-800">Panel de Administrador</h2>
                            <button id="adminLogoutBtn"
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-300 shadow-md">
                                Cerrar Sesión
                            </button>
                        </div>

                        <button id="toggleRegisterFormBtn"
                            class="w-full bg-green-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-700 transition-all duration-300 shadow-md mb-6">
                            ${showRegisterForm ? 'Ocultar Formulario' : 'Registrar Nuevo Cliente'}
                        </button>

                        ${showRegisterForm ? `
                            <div class="bg-gray-50 p-6 rounded-xl mb-6 shadow-inner">
                                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Registrar Cliente</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="newName" placeholder="Nombre del Cliente" required
                                        class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    <input type="text" id="newPaternalLastName" placeholder="Apellido Paterno" required
                                        class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    
                                    <div class="col-span-1 md:col-span-2 grid grid-cols-3 gap-2">
                                        <select id="newDobYear" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                                        <select id="newDobMonth" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                                        <select id="newDobDay" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                                    </div>

                                    <div class="col-span-1 md:col-span-2 grid grid-cols-3 gap-2">
                                        <select id="newWhatsappDialCode" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 col-span-1"></select>
                                        <input type="tel" id="newWhatsappLocalNumber" placeholder="Número de WhatsApp (10 dígitos)" required
                                            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2" />
                                    </div>
                                    
                                    <textarea id="newHouseDetails" placeholder="Detalles de la Casa que Adquiere" rows="3" required
                                        class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 col-span-1 md:col-span-2"></textarea>
                                </div>
                                <button id="registerClientBtn"
                                    class="mt-6 w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-all duration-300 shadow-md">
                                    Registrar Cliente
                                </button>
                                ${adminMessage ? `<p class="mt-4 text-center text-sm text-green-600">${adminMessage}</p>` : ''}
                            </div>
                        ` : ''}

                        <h3 class="text-2xl font-semibold text-gray-700 mb-4">Clientes Registrados</h3>
                        <div id="clientsList" class="space-y-4">
                            ${clients.length === 0 ? `
                                <p class="text-gray-600 text-center py-8">No hay clientes registrados aún.</p>
                            ` : clients.map(client => {
                                const processSteps = JSON.parse(client.PasosProceso || '[]');
                                const completedCount = processSteps.filter(step => step.completed).length;
                                const totalCount = processSteps.length;
                                const currentStepIndex = processSteps.findIndex(step => !step.completed);
                                const currentStepName = currentStepIndex !== -1 ? processSteps[currentStepIndex].stepName : 'Completado';
                                const progressText = totalCount > 0 ? `Paso ${completedCount}/${totalCount}: ${currentStepName}` : 'Sin progreso';

                                return `
                                <div class="bg-gray-50 p-4 rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                    <div>
                                        <p class="font-semibold text-lg text-gray-800">${client.Nombre} ${client.ApellidoPaterno}</p>
                                        <p class="text-sm text-gray-600">Casa: ${client.DetallesCasa}</p>
                                        <p class="text-sm text-gray-600">Usuario: <span class="font-mono">${client.Usuario}</span> | Contraseña: <span class="font-mono">${String(client.Contrasena).padStart(6, '0')}</span></p>
                                        <p class="text-sm font-medium text-blue-700 mt-1">${progressText}</p>
                                    </div>
                                    <div class="flex flex-col sm:flex-row gap-2 mt-3 sm:mt-0">
                                        <button data-client-id="${client.ID}"
                                            class="edit-client-btn px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-300 shadow-md text-sm">
                                            Editar Cliente
                                        </button>
                                        <button data-client-id="${client.ID}"
                                            class="update-status-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-300 shadow-md text-sm">
                                            Actualizar Estatus
                                        </button>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                // Adjuntar listeners de eventos
                document.getElementById('adminLogoutBtn').onclick = handleAdminLogout;
                document.getElementById('toggleRegisterFormBtn').onclick = () => {
                    showRegisterForm = !showRegisterForm;
                    adminMessage = ''; // Limpiar mensaje al alternar formulario
                    updateAdminDashboard();
                    if (showRegisterForm) {
                        populateDateDropdowns('newDobDay', 'newDobMonth', 'newDobYear'); // Llenar los desplegables de fecha
                        populateDialCodeDropdown('newWhatsappDialCode'); // Llenar el desplegable de lada
                    }
                };

                if (showRegisterForm) {
                    document.getElementById('registerClientBtn').onclick = handleRegisterClient;
                    // populateDateDropdowns y populateDialCodeDropdown ya se llaman en el toggle
                }

                document.querySelectorAll('.update-status-btn').forEach(button => {
                    button.onclick = (e) => {
                        const clientId = e.target.dataset.clientId;
                        selectedClientForUpdate = clients.find(c => c.ID === clientId);
                        renderUpdateStatusModal();
                    };
                });

                document.querySelectorAll('.edit-client-btn').forEach(button => {
                    button.onclick = (e) => {
                        const clientId = e.target.dataset.clientId;
                        selectedClientForEdit = clients.find(c => c.ID === clientId);
                        renderEditClientModal();
                    };
                });
            };

            const handleAdminLogout = () => {
                localStorage.removeItem('isAdminLoggedIn');
                navigateTo('login');
                showMessage('Sesión cerrada.', 'info');
            };

            const handleRegisterClient = async () => {
                adminMessage = '';
                const name = document.getElementById('newName').value;
                const paternalLastName = document.getElementById('newPaternalLastName').value;
                
                // Obtener valores de los desplegables de fecha
                const day = document.getElementById('newDobDay').value;
                const month = document.getElementById('newDobMonth').value;
                const year = document.getElementById('newDobYear').value;
                
                // Obtener valores de los desplegables de WhatsApp
                const newWhatsappDialCode = document.getElementById('newWhatsappDialCode').value;
                const newWhatsappLocalNumberRaw = document.getElementById('newWhatsappLocalNumber').value;
                const newWhatsappLocalNumberCleaned = newWhatsappLocalNumberRaw.replace(/\s/g, ''); // Eliminar espacios
                
                const houseDetails = document.getElementById('newHouseDetails').value;

                // Validación de campos vacíos
                if (!name || !paternalLastName || !day || !month || !year || !newWhatsappDialCode || !newWhatsappLocalNumberCleaned || !houseDetails) {
                    adminMessage = 'Por favor, completa todos los campos obligatorios, incluyendo la fecha de nacimiento y el número de WhatsApp.';
                    updateAdminDashboard();
                    showMessage('Por favor, completa todos los campos obligatorios.', 'error');
                    return;
                }
                
                // --- Validación de fecha de nacimiento mejorada ---
                console.log(`Validando fecha de nacimiento: Día=${day}, Mes=${month}, Año=${year}`);
                const parsedYear = parseInt(year);
                const parsedMonth = parseInt(month); // 1-indexed month
                const parsedDay = parseInt(day);

                // Crear un objeto Date usando valores numéricos (el mes es 0-indexed para el constructor Date)
                const testDate = new Date(parsedYear, parsedMonth - 1, parsedDay);

                console.log(`Fecha parseada por JS Date: ${testDate.toLocaleDateString()} (isValid: ${!isNaN(testDate.getTime())})`);
                console.log(`Año de testDate: ${testDate.getFullYear()}, Mes de testDate: ${testDate.getMonth() + 1}, Día de testDate: ${testDate.getDate()}`);

                // Validar si la fecha parseada coincide con la fecha de entrada (maneja desbordamientos como 30 de febrero -> 1 de marzo)
                if (isNaN(testDate.getTime()) ||
                    testDate.getFullYear() !== parsedYear ||
                    testDate.getMonth() + 1 !== parsedMonth || // Comparar con el mes 1-indexed
                    testDate.getDate() !== parsedDay) {
                    adminMessage = 'Fecha de nacimiento inválida. Por favor, selecciona una fecha válida.';
                    updateAdminDashboard();
                    showMessage('Fecha de nacimiento inválida. Verifica el día para el mes y año seleccionados.', 'error');
                    return;
                }
                // --- Fin de validación de fecha de nacimiento mejorada ---

                const dob = `${day}/${month}/${year}`; // Formato DD/MM/YYYY
                
                // Validación de número de WhatsApp (exactamente 10 dígitos después de limpiar espacios)
                if (!/^\d{10}$/.test(newWhatsappLocalNumberCleaned)) {
                    adminMessage = 'El número de WhatsApp debe ser de 10 dígitos numéricos (sin incluir la lada).';
                    updateAdminDashboard();
                    showMessage('El número de WhatsApp debe ser de 10 dígitos numéricos (sin incluir la lada).', 'error');
                    return;
                }

                const username = (name.charAt(0) + paternalLastName)
                                .toLowerCase()
                                .normalize("NFD")
                                .replace(/[\u0300-\u036f]/g, "");
                // Generar contraseña en formato DDMMYY
                const password = day + month + year.substring(2, 4);

                const fullWhatsappNumber = newWhatsappDialCode + newWhatsappLocalNumberCleaned; // Combina lada y número local limpio

                const newClientData = {
                    Nombre: name,
                    ApellidoPaterno: paternalLastName,
                    FechaNacimiento: dob, // Guardar la fecha en formato DD/MM/YYYY
                    Whatsapp: fullWhatsappNumber, // Guardar el número completo de WhatsApp
                    DetallesCasa: houseDetails,
                    Usuario: username,
                    Contrasena: password,
                    PasosProceso: JSON.stringify(defaultProcessSteps), // Guardar como string JSON
                };

                const result = await callAppsScript('addClient', newClientData);
                if (result) {
                    adminMessage = 'Cliente registrado exitosamente!';
                    showMessage('Cliente registrado exitosamente!', 'success');
                    // Limpiar campos del formulario
                    document.getElementById('newName').value = '';
                    document.getElementById('newPaternalLastName').value = '';
                    document.getElementById('newWhatsappLocalNumber').value = ''; // Limpiar solo el número local
                    document.getElementById('newHouseDetails').value = '';
                    // Resetear los selectores de fecha
                    document.getElementById('newDobDay').value = '';
                    document.getElementById('newDobMonth').value = '';
                    document.getElementById('newDobYear').value = '';
                    // Resetear el selector de lada (opcional, se mantiene el default)
                    document.getElementById('newWhatsappDialCode').value = '+52';

                    showRegisterForm = false; // Ocultar formulario después de registrar
                    // Volver a cargar los clientes para refrescar la lista
                    fetchClients(); 
                } else {
                    adminMessage = 'Error al registrar cliente.';
                    updateAdminDashboard();
                }
            };

            // Cargar clientes al iniciar el panel de administrador
            await fetchClients();
        };

        /**
         * Renderiza el modal para actualizar el estatus de un cliente.
         */
        const renderUpdateStatusModal = () => {
            if (!selectedClientForUpdate) return;
            // Los pasos del proceso se almacenan como string JSON en la hoja, así que hay que parsearlos
            let currentProcessSteps = JSON.parse(selectedClientForUpdate.PasosProceso || '[]');
            let modalMessage = '';

            // Define las funciones del modal antes de que se usen en innerHTML
            const closeModal = () => {
                const modal = document.getElementById('updateStatusModalContainer');
                if (modal) {
                    modal.remove();
                }
                selectedClientForUpdate = null;
                // Re-renderiza el dashboard del admin para reflejar cualquier cambio
                renderAdminDashboard();
            };

            const handleUpdateStatus = async () => {
                updateModalMessage('');
                const result = await callAppsScript('updateClient', {
                    id: selectedClientForUpdate.ID,
                    PasosProceso: JSON.stringify(currentProcessSteps)
                });
                if (result) {
                    updateModalMessage('Estatus actualizado exitosamente!', 'success');
                    showMessage('Estatus actualizado para ' + selectedClientForUpdate.Nombre, 'success');
                } else {
                    updateModalMessage('Error al actualizar estatus. Inténtalo de nuevo.', 'error');
                }
            };

            const handleSendWhatsApp = () => {
                updateModalMessage('');
                const completedSteps = currentProcessSteps.filter(step => step.completed).map(step => step.stepName);
                const pendingSteps = currentProcessSteps.filter(step => !step.completed).map(step => step.stepName);

                let whatsappMessage = `¡Hola ${selectedClientForUpdate.Nombre}!\n\n`;
                whatsappMessage += `Hemos actualizado el estatus de tu proceso de compra de casa.\n\n`;
                whatsappMessage += `*Pasos Completados:*\n`;
                if (completedSteps.length > 0) {
                    whatsappMessage += completedSteps.map(step => `✅ ${step}`).join('\n');
                } else {
                    whatsappMessage += 'Ninguno aún.\n';
                }
                whatsappMessage += `\n*Próximos Pasos:*\n`;
                if (pendingSteps.length > 0) {
                    whatsappMessage += pendingSteps.map(step => `⏳ ${step}`).join('\n');
                } else {
                    whatsappMessage += '¡Felicidades, todos los pasos están completados!\n';
                }
                whatsappMessage += `\nPara ver el detalle, ingresa a la plataforma con tu usuario y contraseña.`;

                // Asegurarse de que selectedClientForUpdate.Whatsapp sea una cadena antes de usar .replace()
                const whatsappNumberForUrl = String(selectedClientForUpdate.Whatsapp).replace('+', '');
                const whatsappUrl = `https://wa.me/${whatsappNumberForUrl}?text=${encodeURIComponent(whatsappMessage)}`;
                window.open(whatsappUrl, '_blank');
                updateModalMessage('Mensaje de WhatsApp generado. Revisa la nueva pestaña.', 'info');
                showMessage('Mensaje de WhatsApp generado.', 'info');
            };

            let modalDiv = document.getElementById('updateStatusModalContainer');
            if (!modalDiv) {
                modalDiv = document.createElement('div');
                modalDiv.id = 'updateStatusModalContainer';
                modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                document.body.appendChild(modalDiv);
            }

            modalDiv.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full relative">
                    <button id="closeModalBtn"
                        class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">
                        &times;
                    </button>
                    <h3 class="text-2xl font-extrabold text-gray-800 mb-6">
                        Estatus de ${selectedClientForUpdate.Nombre} ${selectedClientForUpdate.ApellidoPaterno}
                    </h3>

                    <div id="modalStepsList" class="space-y-4 mb-6">
                        ${currentProcessSteps.map((step, index) => `
                            <div class="flex items-center bg-gray-50 p-3 rounded-lg shadow-sm">
                                <input type="checkbox" id="step-${index}" ${step.completed ? 'checked' : ''}
                                    class="form-checkbox h-5 w-5 text-blue-600 rounded-md focus:ring-blue-500" />
                                <label for="step-${index}" class="ml-3 text-lg font-medium ${step.completed ? 'text-green-600 line-through' : 'text-gray-700'}">
                                    ${step.stepName}
                                </label>
                            </div>
                        `).join('')}
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="saveStatusBtn"
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-all duration-300 shadow-md">
                            Guardar Estatus
                        </button>
                        <button id="sendWhatsappBtn"
                            class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-700 transition-all duration-300 shadow-md">
                            Enviar WhatsApp
                        </button>
                    </div>
                    <p id="modalMessage" class="mt-4 text-center text-sm text-gray-600">${modalMessage}</p>
                </div>
            `;

            const updateModalMessage = (msg, type = 'info') => {
                const messageElement = document.getElementById('modalMessage');
                if (messageElement) {
                    messageElement.textContent = msg;
                    messageElement.className = `mt-4 text-center text-sm ${type === 'error' ? 'text-red-600' : 'text-gray-600'}`;
                }
            };

            // Adjuntar listeners de eventos DESPUÉS de que el innerHTML ha sido establecido
            document.getElementById('closeModalBtn').onclick = closeModal;
            document.getElementById('saveStatusBtn').onclick = handleUpdateStatus;
            document.getElementById('sendWhatsappBtn').onclick = handleSendWhatsApp;

            currentProcessSteps.forEach((step, index) => {
                const checkbox = document.getElementById(`step-${index}`);
                if (checkbox) {
                    checkbox.onchange = (e) => {
                        currentProcessSteps[index].completed = e.target.checked;
                        const label = document.querySelector(`label[for="step-${index}"]`);
                        if (e.target.checked) {
                            label.classList.add('text-green-600', 'line-through');
                            label.classList.remove('text-gray-700');
                        } else {
                            label.classList.remove('text-green-600', 'line-through');
                            label.classList.add('text-gray-700');
                        }
                    };
                }
            });
        };

        /**
         * Renderiza el modal para editar los datos de un cliente.
         */
        const renderEditClientModal = () => {
            if (!selectedClientForEdit) return;

            let modalMessage = '';
            
            // Parsear la fecha de nacimiento para preseleccionar los desplegables
            const dobParts = String(selectedClientForEdit.FechaNacimiento).split('/'); // Ensure FechaNacimiento is a string
            const initialDay = dobParts[0];
            const initialMonth = dobParts[1];
            const initialYear = dobParts[2];

            // Parsear el número de WhatsApp para preseleccionar la lada y el número local
            let initialDialCode = '+52'; // Default
            let initialLocalNumber = String(selectedClientForEdit.Whatsapp); // Ensure Whatsapp is a string
            const dialCodePattern = /^\+(\d+)/;
            const match = initialLocalNumber.match(dialCodePattern); // Use initialLocalNumber (which is now a string)
            if (match) {
                initialDialCode = match[0]; // Captura el código con el '+'
                initialLocalNumber = initialLocalNumber.substring(match[0].length);
            }


            let modalDiv = document.getElementById('editClientModalContainer');
            if (!modalDiv) {
                modalDiv = document.createElement('div');
                modalDiv.id = 'editClientModalContainer';
                modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                document.body.appendChild(modalDiv);
            }

            // Define las funciones del modal antes de que se usen en innerHTML
            const closeModal = () => {
                const modal = document.getElementById('editClientModalContainer');
                if (modal) {
                    modal.remove();
                }
                selectedClientForEdit = null;
                renderAdminDashboard(); // Re-renderizar el dashboard para reflejar cambios
            };

            const handleSaveClientChanges = async () => {
                modalMessage = '';
                const name = document.getElementById('editName').value;
                const paternalLastName = document.getElementById('editPaternalLastName').value;
                
                const day = document.getElementById('editDobDay').value;
                const month = document.getElementById('editDobMonth').value;
                const year = document.getElementById('editDobYear').value;
                const dob = `${day}/${month}/${year}`;
                
                const whatsappDialCode = document.getElementById('editWhatsappDialCode').value;
                const whatsappLocalNumberRaw = document.getElementById('editWhatsappLocalNumber').value;
                const whatsappLocalNumberCleaned = whatsappLocalNumberRaw.replace(/\s/g, '');

                const houseDetails = document.getElementById('editHouseDetails').value;

                // Validación de campos vacíos
                if (!name || !paternalLastName || !day || !month || !year || !whatsappDialCode || !whatsappLocalNumberCleaned || !houseDetails) {
                    modalMessage = 'Por favor, completa todos los campos obligatorios.';
                    updateModalContent();
                    showMessage('Por favor, completa todos los campos obligatorios.', 'error');
                    return;
                }

                // Validación de fecha válida
                const parsedYear = parseInt(year);
                const parsedMonth = parseInt(month);
                const parsedDay = parseInt(day);
                const testDate = new Date(parsedYear, parsedMonth - 1, parsedDay);
                if (isNaN(testDate.getTime()) || testDate.getFullYear() !== parsedYear || testDate.getMonth() + 1 !== parsedMonth || testDate.getDate() !== parsedDay) {
                    modalMessage = 'Fecha de nacimiento inválida. Por favor, selecciona una fecha válida.';
                    updateModalContent();
                    showMessage('Fecha de nacimiento inválida.', 'error');
                    return;
                }

                // Validación de número de WhatsApp (10 dígitos)
                if (!/^\d{10}$/.test(whatsappLocalNumberCleaned)) {
                    modalMessage = 'El número de WhatsApp debe ser de 10 dígitos numéricos.';
                    updateModalContent();
                    showMessage('El número de WhatsApp debe ser de 10 dígitos numéricos.', 'error');
                    return;
                }

                const fullWhatsappNumber = whatsappDialCode + whatsappLocalNumberCleaned;

                const updatedClientData = {
                    id: selectedClientForEdit.ID, // ID del cliente para la actualización
                    Nombre: name,
                    ApellidoPaterno: paternalLastName,
                    FechaNacimiento: dob,
                    Whatsapp: fullWhatsappNumber,
                    DetallesCasa: houseDetails,
                    // No se actualizan Usuario y Contrasena desde aquí
                };

                const result = await callAppsScript('updateClientDetails', updatedClientData);
                if (result) {
                    modalMessage = 'Cambios guardados exitosamente!';
                    showMessage('Cliente actualizado exitosamente!', 'success');
                    closeModal(); // Cerrar modal y refrescar dashboard
                } else {
                    modalMessage = 'Error al guardar cambios. Inténtalo de nuevo.';
                    updateModalContent();
                    showMessage('Error al guardar cambios.', 'error');
                }
            };

            const updateModalContent = () => {
                modalDiv.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full relative">
                        <button id="closeEditModalBtn"
                            class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">
                            &times;
                        </button>
                        <h3 class="text-2xl font-extrabold text-gray-800 mb-6">
                            Editar Cliente: ${selectedClientForEdit.Nombre} ${selectedClientForEdit.ApellidoPaterno}
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <input type="text" id="editName" placeholder="Nombre del Cliente" required
                                class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                value="${selectedClientForEdit.Nombre || ''}" />
                            <input type="text" id="editPaternalLastName" placeholder="Apellido Paterno" required
                                class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                value="${selectedClientForEdit.ApellidoPaterno || ''}" />
                            
                            <div class="col-span-1 md:col-span-2 grid grid-cols-3 gap-2">
                                <select id="editDobYear" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                                <select id="editDobMonth" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                                <select id="editDobDay" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                            </div>

                            <div class="col-span-1 md:col-span-2 grid grid-cols-3 gap-2">
                                <select id="editWhatsappDialCode" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 col-span-1"></select>
                                <input type="tel" id="editWhatsappLocalNumber" placeholder="Número de WhatsApp (10 dígitos)" required
                                    class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2"
                                    value="${initialLocalNumber || ''}" />
                            </div>
                            
                            <textarea id="editHouseDetails" placeholder="Detalles de la Casa que Adquiere" rows="3" required
                                class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 col-span-1 md:col-span-2">${selectedClientForEdit.DetallesCasa || ''}</textarea>
                        </div>
                        <button id="saveClientChangesBtn"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-all duration-300 shadow-md">
                            Guardar Cambios
                        </button>
                        <p id="editModalMessage" class="mt-4 text-center text-sm text-red-600">${modalMessage}</p>
                    </div>
                `;

                // Adjuntar listeners y poblar desplegables después de que el HTML esté en el DOM
                document.getElementById('closeEditModalBtn').onclick = closeModal;
                document.getElementById('saveClientChangesBtn').onclick = handleSaveClientChanges;

                populateDateDropdowns('editDobDay', 'editDobMonth', 'editDobYear', initialDay, initialMonth, initialYear);
                populateDialCodeDropdown('editWhatsappDialCode', initialDialCode);
            };

            updateModalContent(); // Renderizar el contenido inicial del modal
        };


        /**
         * Renderiza el panel del cliente.
         */
        const renderClientDashboard = async () => {
            let clientData = null;
            let clientLoading = true;
            let clientMessage = '';

            const fetchClientData = async () => {
                const clientUid = localStorage.getItem('loggedInClientUid');
                if (!clientUid) {
                    clientMessage = 'No se encontró información de cliente. Por favor, inicia sesión de nuevo.';
                    clientLoading = false;
                    updateClientDashboard();
                    return;
                }

                const fetchedClient = await callAppsScript('getClientById', { id: clientUid });
                if (fetchedClient) {
                    clientData = fetchedClient;
                } else {
                    clientMessage = 'No se pudieron cargar tus datos de progreso desde Google Sheets.';
                }

                clientLoading = false;
                updateClientDashboard();
            };

            const updateClientDashboard = () => {
                if (clientLoading) {
                    appContainer.innerHTML = `
                        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                            <p class="text-xl font-semibold text-gray-700">Cargando tu progreso...</p>
                        </div>
                    `;
                    return;
                }

                if (clientMessage || !clientData) {
                    appContainer.innerHTML = `
                        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                            <p class="text-red-600 mb-4">${clientMessage || 'No se pudieron cargar tus datos de progreso.'}</p>
                            <button id="clientLogoutBtn"
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-all duration-300 shadow-md">
                                Volver al Login
                            </button>
                        </div>
                    `;
                    document.getElementById('clientLogoutBtn').onclick = handleClientLogout;
                    return;
                }

                // Los pasos del proceso se almacenan como string JSON en la hoja, así que hay que parsearlos
                const clientProcessSteps = JSON.parse(clientData.PasosProceso || '[]');
                const totalSteps = clientProcessSteps.length;
                const completedStepsCount = clientProcessSteps.filter(step => step.completed).length;
                const progressPercentage = totalSteps > 0 ? (completedStepsCount / totalSteps) * 100 : 0;

                appContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full mx-auto my-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-extrabold text-gray-800">Tu Progreso</h2>
                            <button id="clientLogoutBtn"
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-300 shadow-md">
                                Cerrar Sesión
                            </button>
                        </div>

                        <p class="text-xl font-semibold text-gray-700 mb-2">¡Hola, ${clientData.Nombre}!</p>
                        <p class="text-gray-600 mb-4">Estado de tu proceso de compra para la casa en: <span class="font-medium">${clientData.DetallesCasa}</span></p>

                        <div class="mb-6">
                            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                                <div
                                    class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out"
                                    style="width: ${progressPercentage}%;"
                                ></div>
                            </div>
                            <p class="text-right text-sm font-medium text-gray-700">${Math.round(progressPercentage)}% Completado</p>
                        </div>

                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Detalle del Proceso</h3>
                        <div class="space-y-4">
                            ${clientProcessSteps.map((step, index) => `
                                <div class="flex items-center p-4 rounded-lg shadow-sm ${step.completed ? 'bg-green-50' : 'bg-red-50'}">
                                    <span class="text-2xl mr-4 ${step.completed ? '&#9989;' : '&#128339;'}">
                                    </span>
                                    <p class="text-lg font-medium ${step.completed ? 'text-green-800 line-through' : 'text-gray-800'}">
                                        ${step.stepName}
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.getElementById('clientLogoutBtn').onclick = handleClientLogout;
            };

            const handleClientLogout = () => {
                localStorage.removeItem('loggedInClientUid');
                navigateTo('login');
                showMessage('Sesión cerrada.', 'info');
            };

            await fetchClientData();
        };

        // Iniciar la aplicación cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar la vista de login al cargar
            navigateTo('login');
        });
    </script>
</body>
</html>
